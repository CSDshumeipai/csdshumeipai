<!DOCTYPE html>
<html lang="en">

<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="converterpagecss.css">
	<link rel="shortcut icon" href="https://csdshumeipai.ga/assets/images/dd.png" type="image/x-icon">
    <title>å®ˆæœ›å…ˆé”‹ MIDI åœ°å›¾å·¥åŠè½¬æ¢</title>
</head>

<body>
    <div class="center">
        <a href="https://github.com/ScroogeD2/owmidiconverter">
            <h1>å®ˆæœ›å…ˆé”‹ MIDI åœ°å›¾å·¥åŠè½¬æ¢</h1>
        </a>

        <div>
            <p>â¬† ä¸Šä¼  MIDI æ–‡ä»¶
                <input type="file" id="file-input" accept="audio/midi">
            </p>
        </div>

        <p>ğŸ–± å°†é¼ æ ‡æ‚¬åœåœ¨æ–‡æœ¬ä¸Šä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚<br>
        </p>

        <div class="options">
            <div class="tooltipWrapper">
                <div class="tooltip">â± å¼€å§‹äº:
                    <span class="tooltipText">â• è„šæœ¬å¼€å§‹è¯»å–MIDIæ–‡ä»¶æ—¶æ­Œæ›²ä¸­éŸ³ç¬¦çš„æ—¶é—´ï¼ˆç§’ï¼‰ã€‚è®¾ç½®ä¸º0ä»¥å¤–çš„å€¼ä»¥å¼€å§‹ä»æ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†è¯»å–ã€‚è½¬æ¢å™¨å°†è‡ªåŠ¨ç¡®å®šå®ƒå¯ä»¥é€‚åˆç”Ÿæˆçš„è„šæœ¬çš„æœ€å¤§æ•°æ®é‡ã€‚</span>
                </div>
            </div>
            <input class="textInput" type="text" id="startTimeInput" value="0">

            <div class="tooltipWrapper">
                <div class="tooltip">ğŸ¤– æ¼”å¥æœºå™¨äººæ•°é‡:
                    <span class="tooltipText">â• æ¼”å¥çš„æœºå™¨äººæ•°é‡è®¾ç½®åœ¨6åˆ°11ä¹‹é—´ï¼Œæ·»åŠ æ›´å¤šçš„æœºå™¨äººå¯ä»¥æé«˜æ¼”å¥æ•ˆæœï¼Œä½†æ˜¯è¿™å°†ä¼šå‡å°‘æˆ¿é—´å†…ç©å®¶çš„æ•°é‡ã€‚</span>
                </div>
            </div>
            <input class="textInput" type="text" id="voicesInput" value="6">

            <div class="tooltipWrapper">
                <div class="tooltip">ğŸ”¤ è¯­è¨€:
                    <span class="tooltipText">â• ç”Ÿæˆåœ°å›¾å·¥åŠè„šæœ¬çš„è¯­è¨€ï¼Œé€‰æ‹©ä¸æ¸¸æˆçš„æ–‡å­—è¯­è¨€ç›¸åŒçš„è¯­è¨€ï¼Œå¦åˆ™æ— æ³•å¯¼å…¥è„šæœ¬ã€‚</span>
                </div>
            </div>
            <select class="dropdownInput" id="languageInput">
                <option selected value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                <option value="es-ES">EspaÃ±ol (EU)</option>
                <option value="es-MX">EspaÃ±ol (AL)</option>
                <option value="it-IT">Italiano</option>
                <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                <option value="pl-PL">Polski</option>
                <option value="fr-FR">FranÃ§ais</option>
                <option value="de-DE">Deutsch</option>
                <option value="pt-BR">PortuguÃªs</option>
                <option value="ja-JP">æ—¥æœ¬èª</option>
                <option value="ko-KR">í•œêµ­ì–´</option>
                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
            </select>
        </div>

        <button id="collapseButton" onclick="collapseElementAfter(this)">æ›´å¤šè®¾ç½® â•</button>
        <div class="collapsible">

            <div class="options">
                <div class="tooltipWrapper">
                    <div class="tooltip">âš™ ç”Ÿæˆå®Œæ•´çš„æ¸¸æˆæ¨¡å¼è®¾ç½®
                        <span class="tooltipText">â• å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™ä»…ç”ŸæˆåŒ…å«æ­Œæ›²æ•°æ®çš„ç ”è®¨ä¼šè§„åˆ™ã€‚</span>
                    </div>
                </div>
                <input class="checkboxInput" type="checkbox" id="includeFullSettingsCheckBox" checked>

                <div class="tooltipWrapper">
                    <div class="tooltip">âš™ æœºå™¨äººéšèº«
                        <span class="tooltipText">â• æ¼”å¥æ­Œæ›²çš„æœºå™¨äººéšèº«ã€‚</span>
                    </div>
                </div>
                <input class="checkboxInput" type="checkbox" id="botsInvisibleCheckbox" checked>

                <div class="tooltipWrapper">
                    <div class="tooltip">âš™ é™åˆ¶ç©å®¶æ•°é‡
                        <span class="tooltipText">â• æ ¹æ®æ’­æ”¾æ­Œæ›²çš„æœºå™¨äººæ•°é‡ä»æ¸¸æˆä¸­é™åˆ¶ç©å®¶çš„æ•°é‡ï¼Œç¦ç”¨æ­¤åŠŸèƒ½å¯èƒ½å¯¼è‡´æœºå™¨äººåœ¨æ–°ç©å®¶åŠ å…¥æ—¶æ¶ˆå¤±ã€‚</span>
                    </div>
                </div>
                <input class="checkboxInput" type="checkbox" id="restrictSlotsCheckbox" checked>

                <div class="tooltipWrapper">
                    <div class="tooltip">âš™ é€‰æ‹©æ¼”å¥é’¢ç´ä½ç½®
                        <span class="tooltipText">â• é€‰æ‹©æœºå™¨äººå°†åœ¨å·´é»æ¼”å¥éŸ³ä¹çš„é’¢ç´ä½ç½®ã€‚</span>
                    </div>
                </div>
                <select class="dropdownInput" id="pianoSelectInput">
                    <option value="pointA">Aç‚¹</option>
                    <option selected value="pointB">Bç‚¹</option>
                </select>

                <div class="tooltipWrapper">
                    <div class="tooltip">âš™ ç¦ç”¨ç©å®¶æ‰€æœ‰æŠ€èƒ½
                        <span class="tooltipText">â• å‹¾é€‰æ­¤é€‰é¡¹å¯è§£å†³åœ¨æ¼”å¥æ—¶ç©å®¶æ»¥ç”¨æŠ€èƒ½å¯¼è‡´çš„å£°éŸ³å¹²æ‰°ã€‚</span>
                    </div>
                </div>
                <input class="checkboxInput" type="checkbox" id="restrictAbilitiesCheckbox">
                
                <div class="tooltipWrapper">
                    <div class="tooltip">âš™ ä¼ é€æ»¥ç”¨æŠ€èƒ½çš„ç©å®¶
                        <span class="tooltipText">â• å½“æˆ¿ä¸»æŒ‰ä¸‹Crouchï¼ˆCtrlï¼‰+ Reloadï¼ˆRï¼‰æ—¶ï¼Œä»–ç„å‡†çš„ç©å®¶å°†è¢«ä¼ é€å‡º30ç§’ã€‚</span>
                    </div>
                </div>
                <input class="checkboxInput" type="checkbox" id="includeBanSystemCheckbox">

            </div>
        </div>

        <button onclick="loadFile();">â–¶ å¼€å§‹è½¬æ¢</button>

        <p>ğŸ“ƒ è„šæœ¬ä¿¡æ¯:</p>
        <textarea readonly id="scriptOutput-textarea" rows="7"></textarea>

        <p>â• å¤åˆ¶å·¥åŠä»£ç å¹¶å°†å…¶ç²˜è´´åˆ° <a href="https://i.imgur.com/OqkaGqe.png">â€œè‡ªå®šä¹‰æ¸¸æˆè®¾ç½®ã€‚</a>ï¼ˆä»…é™PCï¼‰</p>
        
        <button id="copyRuleButton" onclick="copyText('ruleOutput-textarea')">ğŸ“„ å¤åˆ¶ä»£ç åˆ°å‰ªåˆ‡æ¿</button>

        <!-- todo: fix textarea lag issues with Chrome -->
        <textarea readonly id="ruleOutput-textarea" rows="5" wrap="off" 
                  autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
        <p></p>
    </div>

    <!-- Import OverPy for language translations -->
    <script src="overpy/utils/other.js"></script>

    <script src="overpy/data/opy/constants.js"></script>
    <script src="overpy/data/opy/internalFunctions.js"></script>
    <script src="overpy/data/opy/functions.js"></script>
    <script src="overpy/data/opy/keywords.js"></script>
    <script src="overpy/data/opy/memberFunctions.js"></script>
    <script src="overpy/data/opy/preprocessing.js"></script>
    <script src="overpy/data/actions.js"></script>
    <script src="overpy/data/values.js"></script>
    <script src="overpy/data/maps.js"></script>
    <script src="overpy/data/heroes.js"></script>
    <script src="overpy/data/gamemodes.js"></script>
    <script src="overpy/data/constants.js"></script>
    <script src="overpy/data/other.js"></script>
    <script src="overpy/data/customGameSettings.js"></script>
    <script src="overpy/data/opy/annotations.js"></script>
    
    <script src="overpy/globalVars.js"></script>
    
    <script src="overpy/utils/ast.js"></script>
    <script src="overpy/utils/types.js"></script>
    <script src="overpy/utils/compilation.js"></script>
    <script src="overpy/utils/decompilation.js"></script>
    <script src="overpy/utils/file.js"></script>
    <script src="overpy/utils/logging.js"></script>
    <script src="overpy/utils/optimization.js"></script>
    <script src="overpy/utils/strings.js"></script>
    <script src="overpy/utils/translation.js"></script>
    <script src="overpy/utils/varNames.js"></script>
    <script src="overpy/utils/tokens.js"></script>
    
    <script src="overpy/decompiler/decompileTest.js"></script>
    <script src="overpy/decompiler/workshopToAst.js"></script>
    <script src="overpy/decompiler/astToOpy.js"></script>
    <script src="overpy/decompiler/decompiler.js"></script>
    
    <script src="overpy/compiler/obfuscation.js"></script>
    <script src="overpy/compiler/functions/__add__.js"></script>
    <script src="overpy/compiler/functions/__and__.js"></script>
    <script src="overpy/compiler/functions/__append__.js"></script>
    <script src="overpy/compiler/functions/__array__.js"></script>
    <script src="overpy/compiler/functions/__arraySlice__.js"></script>
    <script src="overpy/compiler/functions/__assignTo__.js"></script>
    <script src="overpy/compiler/functions/__button__.js"></script>
    <script src="overpy/compiler/functions/__del__.js"></script>
    <script src="overpy/compiler/functions/__dict__.js"></script>
    <script src="overpy/compiler/functions/__distanceTo__.js"></script>
    <script src="overpy/compiler/functions/__divide__.js"></script>
    <script src="overpy/compiler/functions/__doWhile__.js"></script>
    <script src="overpy/compiler/functions/__elif__.js"></script>
    <script src="overpy/compiler/functions/__else__.js"></script>
    <script src="overpy/compiler/functions/__equals__.js"></script>
    <script src="overpy/compiler/functions/__for__.js"></script>
    <script src="overpy/compiler/functions/__format__.js"></script>
    <script src="overpy/compiler/functions/__filteredArray__.js"></script>
    <script src="overpy/compiler/functions/__gamemode__.js"></script>
    <script src="overpy/compiler/functions/__greaterThan__.js"></script>
    <script src="overpy/compiler/functions/__greaterThanOrEquals__.js"></script>
    <script src="overpy/compiler/functions/__hero__.js"></script>
    <script src="overpy/compiler/functions/__if__.js"></script>
    <script src="overpy/compiler/functions/__ifThenElse__.js"></script>
    <script src="overpy/compiler/functions/__indexOfArrayValue__.js"></script>
    <script src="overpy/compiler/functions/__inequals__.js"></script>
    <script src="overpy/compiler/functions/__lastOf__.js"></script>
    <script src="overpy/compiler/functions/__lessThan__.js"></script>
    <script src="overpy/compiler/functions/__lessThanOrEquals__.js"></script>
    <script src="overpy/compiler/functions/__map__.js"></script>
    <script src="overpy/compiler/functions/__mappedArray__.js"></script>
    <script src="overpy/compiler/functions/__modulo__.js"></script>
    <script src="overpy/compiler/functions/__multiply__.js"></script>
    <script src="overpy/compiler/functions/__negate__.js"></script>
    <script src="overpy/compiler/functions/__not__.js"></script>
    <script src="overpy/compiler/functions/__or__.js"></script>
    <script src="overpy/compiler/functions/__raiseToPower__.js"></script>
    <script src="overpy/compiler/functions/__remove__.js"></script>
    <script src="overpy/compiler/functions/__rule__.js"></script>
    <script src="overpy/compiler/functions/__skip__.js"></script>
    <script src="overpy/compiler/functions/__subtract__.js"></script>
    <script src="overpy/compiler/functions/__switch__.js"></script>
    <script src="overpy/compiler/functions/__valueInArray__.js"></script>
    <script src="overpy/compiler/functions/__while__.js"></script>
    <script src="overpy/compiler/functions/__xComponentOf__.js"></script>
    <script src="overpy/compiler/functions/__yComponentOf__.js"></script>
    <script src="overpy/compiler/functions/__zComponentOf__.js"></script>
    <script src="overpy/compiler/functions/all.js"></script>
    <script src="overpy/compiler/functions/any.js"></script>
    <script src="overpy/compiler/functions/break.js"></script>
    <script src="overpy/compiler/functions/continue.js"></script>
    <script src="overpy/compiler/functions/createBeam.js"></script>
    <script src="overpy/compiler/functions/disableInspector.js"></script>
    <script src="overpy/compiler/functions/enableInspector.js"></script>
    <script src="overpy/compiler/functions/print.js"></script>
    <script src="overpy/compiler/functions/sorted.js"></script>
    <script src="overpy/compiler/functions/vect.js"></script>
    
    <script src="overpy/compiler/tokenizer.js"></script>
    <script src="overpy/compiler/astParser.js"></script>
    <script src="overpy/compiler/astToWorkshop.js"></script>
    <script src="overpy/compiler/parser.js"></script>
    <script src="overpy/compiler/compiler.js"></script>
    <script src="overpy/data/localizedStrings.js"></script>
    <!-- End of OverPy imports -->
    
    <!-- todo: only import convertMidi and CONVERTER_SETTINGS_INFO instead of the whole file -->
    <script type="text/javascript" src="src/owmidiparser.js"></script>
    <script type="text/javascript" src="src/workshopScript_en-US.js"></script>

    <script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script>

    <script>
        "use strict";

        const ERRORS = {
            MIDI_CONVERTER_ERROR: "Error: the MIDI file could not be converted.\n",
            TRANSLATION_ERROR: "Error: the generated workshop script could not be translated.\n",
            GENERAL_ERROR: "An error occurred. Please check the console: F12 (Firefox) or Ctrl+Shift+J (Chrome).\n"
        };

        // Maximum amount of players in an Overwatch match
        const MAX_PLAYERS = 12;


        function loadFile() {
            let file = document.getElementById("file-input").files[0];
            if (!file) {
                return;
            }

            updateElementValue("scriptOutput-textarea", "");
            updateElementValue("ruleOutput-textarea", "");

            const reader = new FileReader();

            reader.onload = function (event) {
                try {
                    // Read MIDI file with Tonejs/Midi
                    let mid = new Midi(event.target.result);
                    parseMidi(mid);
                }
                catch (error) {
                    updateElementValue("scriptOutput-textarea", ERRORS["GENERAL_ERROR"]);
                    console.error(error);
                }
            }
            reader.readAsArrayBuffer(file);
        }
        

        function parseMidi(mid) {
            // Converts MIDI data, outputs it

            const converterSettings = getConverterSettings();
            let convertedMidi = {};
            
            try {
                convertedMidi = convertMidi(mid, converterSettings, true);
            }
            catch (error) {
                updateElementValue("scriptOutput-textarea", ERRORS["MIDI_CONVERTER_ERROR"]);
                console.error(error);
                return;
            }

            if (convertedMidi.rules == "") {
                let output = "";
                for (let error of convertedMidi.errors) {
                    output += error;
                } 
                for (let warning of convertedMidi.warnings) {
                    output += warning;
                } 
                updateElementValue("scriptOutput-textarea", output);

            } else {
                let scriptLanguage = document.getElementById("languageInput").value;
                let customGameSettings = "";

                if (document.getElementById("includeFullSettingsCheckBox").checked) {
                    // Add BASE_SETTINGS
                    customGameSettings += generateIngameSettings(converterSettings["voices"]);
                } else {
                    // Only add variables used in the converted midi script
                    customGameSettings += CONVERTED_MIDI_VARS;
                }

                customGameSettings += convertedMidi.rules;

                if (scriptLanguage != "en-US") {
                    customGameSettings = translateWorkshopScript(customGameSettings, scriptLanguage);
                }
                
                let scriptOutput = "";
                scriptOutput += `${convertedMidi.skippedNotes} note(s) left out due to too many overlapping pitches\n` +
                                `${convertedMidi.transposedNotes} note(s) transposed\n` +
                                `${converterSettings["voices"]} voice(s)\n\n`;
                
                if (convertedMidi.warnings.length != 0) {
                    for (let warning of convertedMidi.warnings) {
                        scriptOutput += warning;
                    } 
                }

                scriptOutput += `MIDI file successfully read from ${converterSettings["startTime"]} second(s) ` +
                                `to ${roundToPlaces(convertedMidi.stopTime, 1)} second(s),\n` +
                                `${Math.round(100*(convertedMidi.stopTime - converterSettings["startTime"]) / convertedMidi.duration)}% ` +
                                `of the song converted to workshop arrays.\n` +
                                `Language: ${scriptLanguage}\n`;

                updateElementValue("scriptOutput-textarea", scriptOutput);
                updateElementValue("ruleOutput-textarea", customGameSettings + "\n");
            }
        }

        
        function getConverterSettings() {
            // Reads the values in the webpage input fields, 
            // ensures that they're in the correct numerical ranges

            let userSettings = {};

            for (let setting in CONVERTER_SETTINGS_INFO) {

                let userValue = parseFloat(document.getElementById(setting + "Input").value);

                if (isNaN(userValue)) {
                    userValue = CONVERTER_SETTINGS_INFO[setting]["DEFAULT"];
                }

                else if (userValue < CONVERTER_SETTINGS_INFO[setting]["MIN"]) {
                    userValue = CONVERTER_SETTINGS_INFO[setting]["MIN"];
                }

                else if (userValue > CONVERTER_SETTINGS_INFO[setting]["MAX"]) {
                    userValue = CONVERTER_SETTINGS_INFO[setting]["MAX"];
                }

                document.getElementById(setting + "Input").value = userValue;
                userSettings[setting] = userValue;
            }

            return userSettings;
        }
        

        function generateIngameSettings(maxBots) {
            // Modifies BASE_SETTINGS based on the user's selected settings, 
            // and returns the modified script.

            const userSettings = {
                botsInvisible: document.getElementById("botsInvisibleCheckbox").checked,
                restrictSlots: document.getElementById("restrictSlotsCheckbox").checked,
                selectedPiano: document.getElementById("pianoSelectInput").value,
                restrictAbilities: document.getElementById("restrictAbilitiesCheckbox").checked,
                includeBanSystem: document.getElementById("includeBanSystemCheckbox").checked
            };

            let customGameSettings = BASE_SETTINGS;

            if (!userSettings.botsInvisible) {
                customGameSettings = customGameSettings.replace(SCRIPTS["botsInvisible"], "");
            }

            if (userSettings.restrictSlots) {
                customGameSettings = customGameSettings.replace(SCRIPTS["restrictSlots"], 
                                                                `Max Team 1 Players: ${MAX_PLAYERS - maxBots}`)
            }
            
            customGameSettings += PIANO_POSITION_SCRIPTS[userSettings.selectedPiano];
            
            if (!userSettings.restrictAbilities) {
                customGameSettings = customGameSettings.replace(SCRIPTS["restrictAbilities"], "");
            }
            
            if (!userSettings.includeBanSystem) {
                customGameSettings = customGameSettings.replace(SCRIPTS["includeBanSystem"], "");
            }
            return customGameSettings;
            
        }

        function translateWorkshopScript(script, language) {
            // Translates by decompiling to OverPy script, 
            // then compiling back to workshop script in the selected language

            try {
                let overpyScript = decompileAllRules(script);

                return compile(overpyScript, language).result;
            }
            catch (error) {
                updateElementValue("scriptOutput-textarea", ERRORS["TRANSLATION_ERROR"]);
                console.error(error);
            }
        }

            
        function copyText(elementId) {
            // Copy to clipboard
            document.getElementById(elementId).select();
            document.execCommand("copy");
        }
        
        function collapseElementAfter(element1) {
            // Toggles the visibility of the element after element1, switches "+" with "â€“"

            let collapsibleElement = element1.nextElementSibling;
            
            if (collapsibleElement.style.display === "block") {
                collapsibleElement.style.display = "none";
                element1.innerHTML = element1.innerHTML.replace("â€“", "+")
            } else {
                collapsibleElement.style.display = "block";
                element1.innerHTML = element1.innerHTML.replace("+", "â€“")
            }
        }

        function updateElementValue(elementId, newValue, keepOldText = false) {
            // Updates text in a webpage element.

            let outputText = "";
            let oldValue = document.getElementById(elementId).value;

            if (keepOldText) {
                outputText = oldValue + newValue;
            } else {
                outputText = newValue;
            }
            document.getElementById(elementId).value = outputText;
        }
    </script>
</body>

</html>
